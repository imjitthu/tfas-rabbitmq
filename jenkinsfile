pipeline { //pipeline

    agent any
    options { disableConcurrentBuilds() }

    stages ('Setup Roboshop Application') { //stages
        stage ('Installing rabbitmq Server') { //rabbitmq stage
            steps { //rabbitmq steps
            withCredentials([aws(accessKeyVariable: 'AWS_ACCESS_KEY_ID', credentialsId: 'awskey', secretKeyVariable: 'AWS_SECRET_ACCESS_KEY')]) {
                    git 'https://github.com/imjitthu/tfas-rabbitmq.git'
                    //sh 'terraform destroy -auto-approve'
                    sh 'terraform init'
                    sh 'terraform plan'
                    //sh 'terraform apply -auto-approve'
                    } //with credentials
            //ansiblePlaybook credentialsId: 'DevOps321', installation: 'ansibletool', inventory: 'rabbitmq_inv', playbook: 'rabbitmq.yml'
                } //rabbitmq steps
            } //rabbitmq stage
        } //stages
    //         post { 
    //     always { 
    //         withCredentials([aws(accessKeyVariable: 'AWS_ACCESS_KEY_ID', credentialsId: 'awskey', secretKeyVariable: 'AWS_SECRET_ACCESS_KEY')]) {
    //                 //sh 'terraform init'
    //                 sh 'terraform destroy -auto-approve'
    //                 } //with credentials
    //     }
    // }
    } //pipeline